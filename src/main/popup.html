<!-- 
	Copyright 2010 Kenneth Liu.
 
	This file is part of ChromeItLater.

    ChromeItLater is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation, either version 2 of the License, or
    any later version.

    ChromeItLater is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.

    You should have received a copy of the GNU General Public License
    along with ChromeItLater.  If not, see <http://www.gnu.org/licenses/>.
-->
<!DOCTYPE HTML>
<html>
<head>
	<link rel="stylesheet" type="text/css" href="chromeitlater.css" />
	<script src="readitlater-client.js"></script>
	<script src="common.js"></script> 
	<script type="text/javascript" charset="utf-8">
	
	function loaded() {
		if (!isInitialized() || !isLoginConfigured()) {
			chrome.tabs.create({'url': 'options.html'}, null);
			window.close();
			return;
		}		
		
		if (localStorage.add_instantly === 'true') {
			container.innerHTML = ''; //clear the popup so we don't see an empty form briefly
 			chrome.tabs.getSelected(null, 
				function(tab) { 
					console.debug(tab)
					add(localStorage.username, localStorage.password, tab.url, encodeURIComponent(tab.title), 
						function (status, responseText) {
							if (status == '200') {
								if(localStorage.close_tab === 'true') {
									chrome.tabs.remove(tab.id, 
										function() { console.debug("closed tab" + tab.url); }
								  	);              
								}
								window.close(); //TODO we shouldn't have to close the form because the popup really shouldn't be visible in the first place - newer chrome builds will allow override of popup so this logic will move elsewhere
							} 
						   	else {
								container.innerHTML = '<b>Error adding page</b><br/><small>' + responseText + '</small>';
								window.setTimeout(function() { window.close(); }, 1500);
							}
						}
					);
			});
		} else {
			populateForm();
		}
	}
	
	function populateForm() {
		chrome.tabs.getSelected(null, 
			function(tab) { 
				console.debug(tab);
				title.value = tab.title;
				url.value = tab.url;
			}
		);			
	}

	function clicked() {		
		var urlval = url.value;
		var titleval = title.value;
		container.innerHTML = "Adding URL...";
		
		//TODO this is starting to look like lisp!
		chrome.tabs.getSelected(null, 
			function(tab) {
				add(localStorage.username, localStorage.password, urlval, encodeURI(titleval),
					function (status, responseText) {
						if (status == '200') {
							container.innerHTML = "<b>Page added successfully!</b>";
							if(localStorage.close_tab === 'true'){
								chrome.tabs.remove(tab.id, 
									function() { console.debug("closed tab" + tab.url); }
							  	);              
							}
						} 
					   	else {
							container.innerHTML = '<b>Error adding page</b><br/><small>' + responseText + '</small>';
						}
						window.setTimeout(function() { window.close(); }, 1500);
		   			}
				);
			}
		);
	}    
	
	function handleExtensionNotConfigured(){
		
	}
	
	//for testing
	function a(){
		document.getElementById('container').innerHTML = "<b>Page added!</b>";		
	}
	</script>
</head>           

<body id="popup" onload="loaded()">
	<!-- goofy styling to get vertically centered text -->
<!--	<div style="display:table;height:100px;width:200px;">-->
	<div id="container" style="display:table-cell;vertical-align:middle;text-align:center;">
		<table>
			<tr>
				<td><label for="title">Title</label></td><td><input type="text" name="title" value="" id="title" size="50"></td>
			</tr>
			<tr>
				<td><label for="url">URL</label></td><td><input type="text" name="url" value="" id="url" size="50"></td>
			</tr>
		<!--	<label for="tags">Tags</label><input type="text" name="tags" value="" id="tags"> -->
		</table>
		<button onClick='clicked()'>Add</button>
	</div></div>
</body>
</html>